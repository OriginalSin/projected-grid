<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>CDLOD Plane - Jérémy BOUNY</title>
		<link href="style.css" rel="stylesheet">
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	</head>

	<body>	
		<div id="canvas-3d" class="viewer"></div>
		
		<script id="vertexShader" type="x-shader/x-vertex">

			precision mediump float;
			precision mediump int;

			uniform float time;
			uniform float near, far;

			uniform mat4 modelViewMatrix; // optional
			uniform mat4 projectionMatrix; // optional

			attribute vec3 position;
			attribute vec4 color;
			
			varying vec4 vPosition;
			varying vec3 vScreenPosition;
			varying vec4 vColor;
			varying vec4 vWorldPosition;

			const vec3 groundNormal = vec3(0.0,0.0,1.0); //facing up
			const float groundHeight = 0.0;

			vec3 intercept(vec3 lineP, vec3 lineN, vec3 planeN, float planeD)
			{
				float distance = (planeD - dot(planeN, lineP)) /dot(lineN, planeN);
				return lineP + lineN * distance;
			}
			
			vec3 getCameraPos()
			{
				vec3 d = modelViewMatrix[3].xyz;
				mat3 rotMat = mat3( 
					modelViewMatrix[0].xyz,
					modelViewMatrix[1].xyz,
					modelViewMatrix[2].xyz
				);

				// Xc = R * Xw + t
				// c = - R.t() * t <=> c = - t.t() * R
				vec3 retVec = - d * rotMat;
				return retVec;
			}
			
			float worldDepthToZDepth( float inZ )
			{
				return ( far + near ) / ( far - near ) + ( 1.0 / inZ ) * ( ( -2.0 * far * near ) / ( far - near ) );
			}

			vec2 getViewPosition(vec2 coord)
			{
				//return vec3( coord, 1.0 );
				
				// Extracting aspect from projection matrix:
				// P = | e   0       0   0 |
				//     | 0   e/(h/w) 0   0 |
				//     | 0   0       .   . |
				//     | 0   0       -1  0 |
				
				float focal = projectionMatrix[0][0];
				float aspect = projectionMatrix[1][1] / focal;
				
				return vec2( coord.x * aspect, coord.y );
				//float aspect = (width/height);
				/*float scale = 1.0;
				if(width>height)
				{
					scale = aspect;
				}   
				vec3 pos;
				pos = vec3(coord.s*aspect*tan(fov/2.0),coord.t*tan(fov/2.0),tan(fov/2.0)*scale);
				return pos;*/
			}
			
			vec4 get3dPoint( vec2 inViewPosition ) {
				return vec4( inViewPosition.x, 0.0, inViewPosition.y, 1.0 );
			}

			void main()	{

				vec3 cameraPosition = getCameraPos();
				vec4 ray = projectionMatrix * vec4( cameraPosition, 1.0 );
			
				vScreenPosition = position;
				vPosition = projectionMatrix * vec4( position, 1.0 );
				vWorldPosition = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				vec2 viewPosition = getViewPosition( vPosition.xy ) ;
				
				//vec4 origin = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
				vec4 origin = projectionMatrix * modelViewMatrix * get3dPoint( viewPosition );
				
				gl_Position = vec4( vec3( viewPosition.xy, worldDepthToZDepth( origin.z ) ), 1.0 );
				
				vColor = vec4( normalize( vScreenPosition.xyz + vec3( 0.1 )), 1.0 );
				//vColor = vec4( normalize( ray.xyz ), 1.0 );
			}

		</script>

		<script id="fragmentShader" type="x-shader/x-fragment">

			precision mediump float;
			precision mediump int;

			uniform float time;
			
			varying vec4 vPosition;
			varying vec3 vScreenPosition;
			varying vec4 vColor;

			void main()	{

				gl_FragColor = vec4( 0.5 );
				gl_FragColor = vColor;
				//gl_FragColor = vec4( normalize(vScreenPosition.xyx), 1.0 );

			}

		</script>
		
		<!--

			void main()	{

				vScreenPosition = position;
				vPosition = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				vPosition = vec4( position, 1.0 );
				gl_Position = vPosition;
			}

		</script>

		<script id="fragmentShader" type="x-shader/x-fragment">

			precision mediump float;
			precision mediump int;

			uniform float time;
			
			varying vec4 vPosition;
			varying vec3 vScreenPosition;

			void main()	{

				gl_FragColor = vec4( normalize(vScreenPosition.xyx), 1.0 );

			}

		</script>-->
		
		<!-- External libraries -->	
		<script src="../../libs/three.js/index.js"></script>
		<script src="../../libs/OrbitControl/index.js"></script>
		<script src="../../libs/zepto/zepto.min.js"></script>
		
		<!-- Demo files -->
		<script src="demo.js"></script>
	</body>
</html>